<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常乐经营管理周报</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- 引入React和ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入Babel用于JSX转换 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 主应用脚本 -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 门店数量统计数据（直接嵌入CSV数据）
        const storeDataCSV = `时间,城市,新开目标,新开实际,闭店,年末数,净增长,目标对照
2019,上海,,,,,,
2019,北京,,,,,,
2019,南京,,,,,,
2019,四川,,,,64,,
2019,宁波,,,,,,
2019,广州,,,,,,
2019,杭州,,,,,,
2019,深圳,,,,,,
2019,重庆,,,,11,,
2020,上海,0,0,0,0,0,0
2020,北京,0,0,0,0,0,0
2020,南京,0,0,0,0,0,0
2020,四川,0,15,8,71,7,7
2020,宁波,0,0,0,0,0,0
2020,广州,0,0,0,0,0,0
2020,杭州,0,0,0,0,0,0
2020,深圳,0,1,0,1,1,1
2020,重庆,0,7,1,17,6,6
2021,上海,0,0,0,0,0,0
2021,北京,0,0,0,0,0,0
2021,南京,0,0,0,0,0,0
2021,四川,0,13,4,80,9,9
2021,宁波,0,0,0,0,0,0
2021,广州,0,0,0,0,0,0
2021,杭州,0,5,0,5,5,5
2021,深圳,0,8,0,9,8,8
2021,重庆,0,8,0,25,8,8
2022,上海,0,0,0,0,0,0
2022,北京,0,0,0,0,0,0
2022,南京,0,3,0,3,3,3
2022,四川,0,8,8,80,0,0
2022,宁波,0,0,0,0,0,0
2022,广州,0,0,0,0,0,0
2022,杭州,0,1,0,6,1,1
2022,深圳,0,2,1,10,1,1
2022,重庆,0,3,3,25,0,0
2023,上海,3,4,0,4,4,1
2023,北京,0,0,0,0,0,0
2023,南京,3,1,0,4,1,-2
2023,四川,10,10,4,86,6,-4
2023,宁波,3,2,0,2,2,-1
2023,广州,3,3,0,3,3,0
2023,杭州,3,2,0,8,2,-1
2023,深圳,3,6,0,16,6,3
2023,重庆,3,4,0,29,4,1
2024,上海,4,4,1,7,3,-1
2024,北京,3,4,0,4,4,1
2024,南京,2,0,0,4,0,-2
2024,四川,6,16,12,90,4,-2
2024,宁波,2,1,0,3,1,-1
2024,广州,3,4,0,7,4,1
2024,杭州,2,1,0,9,1,-1
2024,深圳,6,7,1,22,6,0
2024,重庆,3,2,1,30,1,-2
2025,上海,0,2,0,9,2,2
2025,北京,6,9,0,13,9,3
2025,南京,0,1,0,5,1,1
2025,四川,6,10,9,91,1,-5
2025,宁波,0,0,0,3,0,0
2025,广州,0,2,0,9,2,2
2025,杭州,0,3,1,11,2,2
2025,深圳,6,7,2,27,5,-1
2025,重庆,2,2,2,30,0,-2`;

        // 数据处理工具函数
        const parseCSV = (csvText) => {
          const lines = csvText.trim().split('\n');
          const headers = lines[0].split(',');
          const rows = [];
          
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] || '';
            });
            rows.push(row);
          }
          
          return { headers, rows };
        };
        
        // 获取唯一的年份列表
        const getUniqueYears = (data) => {
          const years = [...new Set(data.rows.map(row => row['时间']))];
          return years.filter(year => year).sort();
        };
        
        // 获取唯一的城市列表
        const getUniqueCities = (data) => {
          const cities = [...new Set(data.rows.map(row => row['城市']))];
          return ['全部', ...cities.filter(city => city).sort()];
        };
        
        // 获取指标字段（除时间和城市外的其他字段）
        const getMetricsFields = (headers) => {
          return headers.filter(header => header !== '时间' && header !== '城市');
        };
        
        const WeeklyReport = () => {
          // Tab导航状态管理
          const [activeTab, setActiveTab] = useState(0);
          
          // 门店经营数量数据状态
          const [storeData, setStoreData] = useState(null);
          const [selectedYears, setSelectedYears] = useState(['2025']);
          const [selectedCities, setSelectedCities] = useState(['全部']);
          const [selectedMetric, setSelectedMetric] = useState('新开实际');
          const [metricsFields, setMetricsFields] = useState([]);
          const [filteredData, setFilteredData] = useState([]);
          
          // 下拉筛选框展开状态
          const [dropdownOpen, setDropdownOpen] = useState({
            time: false,
            city: false,
            metric: false
          });
          
          // Tab列表
          const tabs = [
            "战略指标",
            "新店总结",
            "营业额总结-客单价",
            "营业额总结-客次量",
            "利润总结"
          ];

          // 获取当前日期
          const getCurrentDate = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}年${month}月${day}日`;
          };
          
          // 加载CSV数据
          useEffect(() => {
            const parsedData = parseCSV(storeDataCSV);
            setStoreData(parsedData);
            
            // 设置指标字段
            const metrics = getMetricsFields(parsedData.headers);
            setMetricsFields(metrics);
            
            // 设置默认筛选数据
            const uniqueYears = getUniqueYears(parsedData);
            const uniqueCities = getUniqueCities(parsedData);
          }, []);
          
          // 当筛选条件改变时更新数据
          useEffect(() => {
            if (storeData && selectedMetric) {
              const filtered = storeData.rows.filter(row => {
                const yearMatch = selectedYears.length === 0 || selectedYears.includes(row['时间']);
                const cityMatch = selectedCities.includes('全部') || selectedCities.length === 0 || selectedCities.includes(row['城市']);
                return yearMatch && cityMatch;
              });
              setFilteredData(filtered);
            }
          }, [storeData, selectedYears, selectedCities, selectedMetric]);
          
          // 处理年份选择变化
          const handleYearChange = (year) => {
            if (selectedYears.includes(year)) {
              setSelectedYears(selectedYears.filter(y => y !== year));
            } else {
              setSelectedYears([...selectedYears, year]);
            }
          };
          
          // 处理城市选择变化
          const handleCityChange = (city) => {
            if (city === '全部') {
              if (selectedCities.includes('全部')) {
                setSelectedCities([]);
              } else {
                setSelectedCities(['全部']);
              }
            } else {
              const newSelected = selectedCities.filter(c => c !== '全部');
              if (newSelected.includes(city)) {
                setSelectedCities(newSelected.filter(c => c !== city));
              } else {
                setSelectedCities([...newSelected, city]);
              }
            }
          };
          
          // 切换下拉框展开状态
          const toggleDropdown = (dropdownName) => {
            setDropdownOpen(prev => ({
              ...prev,
              [dropdownName]: !prev[dropdownName]
            }));
          };
          
          // 渲染下拉筛选框
          const renderDropdown = (label, options, selectedValues, handleChange, dropdownName) => {
            return (
              <div className="mb-4 relative">
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <div 
                  className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#a40035] focus:border-[#a40035] sm:text-sm bg-white cursor-pointer"
                  onClick={() => toggleDropdown(dropdownName)}
                >
                  <div className="flex justify-between items-center">
                    <span>
                      {dropdownName === 'time' && selectedValues.length > 0 
                        ? selectedValues.join(', ') 
                        : dropdownName === 'city' && selectedValues.length > 0
                        ? selectedValues.join(', ')
                        : dropdownName === 'metric' 
                        ? selectedMetric
                        : `请选择${label}`}
                    </span>
                    <svg 
                      className={`w-4 h-4 transition-transform ${dropdownOpen[dropdownName] ? 'rotate-180' : ''}`} 
                      fill="none" 
                      stroke="currentColor" 
                      viewBox="0 0 24 24"
                    >
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                </div>
                
                {dropdownOpen[dropdownName] && (
                  <div className="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-200 max-h-60 overflow-y-auto">
                    <div className="p-2">
                      {options.map(option => (
                        <div key={option} className="flex items-center py-1">
                          <input
                            type="checkbox"
                            id={`${dropdownName}-${option}`}
                            checked={dropdownName === 'metric' 
                              ? selectedMetric === option 
                              : selectedValues.includes(option)}
                            onChange={() => dropdownName === 'metric' 
                              ? setSelectedMetric(option) 
                              : handleChange(option)}
                            className="mr-2 h-4 w-4 text-[#a40035] border-gray-300 rounded focus:ring-[#a40035]"
                          />
                          <label 
                            htmlFor={`${dropdownName}-${option}`} 
                            className="text-sm text-gray-700 cursor-pointer"
                          >
                            {option}
                          </label>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            );
          };
          
          // 渲染数据表格
          const renderDataTable = () => {
            if (!storeData || filteredData.length === 0) {
              return <div className="text-center py-4 text-gray-500">暂无数据</div>;
            }
            
            return (
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">城市</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{selectedMetric}</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {filteredData.map((row, index) => (
                      <tr key={index}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row['时间'] || '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row['城市'] || '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row[selectedMetric] || '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-50">
              {/* 标题区域 */}
              <header 
                className="bg-gradient-to-r from-[#a40035] to-[#c81f52] text-white"
              >
                <div className="container mx-auto px-4 py-8">
                  {/* 副标题 */}
                  <p className="text-sm md:text-base font-light tracking-wider mb-2 text-white/90">
                    AI 经营分析洞察
                  </p>
                  
                  {/* 主标题 */}
                  <h1 className="text-3xl md:text-4xl font-bold text-center mb-6">
                    常乐经营管理周报
                  </h1>
                  
                  {/* 更新时间 */}
                  <p className="text-center text-white/90 text-sm md:text-base">
                    更新时间：{getCurrentDate()}
                  </p>
                </div>
              </header>

              {/* 内容切换区域 */}
              <main className="container mx-auto px-4 py-6">
                {/* Tab导航 */}
                <div className="flex flex-wrap gap-2 md:gap-4 mb-8 border-b border-gray-200 pb-2">
                  {tabs.map((tab, index) => (
                    <button
                      key={index}
                      onClick={() => setActiveTab(index)}
                      className={`px-3 py-2 text-sm md:text-base font-medium rounded-t-lg transition-colors ${
                        activeTab === index
                          ? "text-[#a40035] font-bold border-b-2 border-[#a40035]"
                          : "text-gray-700 hover:text-[#a40035]"
                      }`}
                    >
                      {tab}
                    </button>
                  ))}
                </div>

                {/* 内容区域 */}
                <div className="bg-white rounded-lg shadow p-4 md:p-6 min-h-[400px]">
                  {activeTab === 0 && (
                    <div className="space-y-8">
                      <h2 className="text-2xl font-bold text-gray-800">战略指标</h2>
                      
                      {/* 三个数据容器垂直排列 */}
                      <div className="space-y-6">
                        {/* 门店经营数量 */}
                        <div className="border border-gray-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">门店经营数量</h3>
                          
                          {/* 筛选区域 */}
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            {storeData && (
                              <>
                                <div>
                                  {renderDropdown(
                                    "时间", 
                                    getUniqueYears(storeData), 
                                    selectedYears, 
                                    handleYearChange,
                                    'time'
                                  )}
                                </div>
                                <div>
                                  {renderDropdown(
                                    "城市", 
                                    getUniqueCities(storeData), 
                                    selectedCities, 
                                    handleCityChange,
                                    'city'
                                  )}
                                </div>
                                <div>
                                  {renderDropdown(
                                    "指标", 
                                    metricsFields, 
                                    [], 
                                    () => {},
                                    'metric'
                                  )}
                                </div>
                              </>
                            )}
                          </div>
                          
                          {/* 数据展示区域 */}
                          <div className="border border-gray-200 rounded-md">
                            {renderDataTable()}
                          </div>
                        </div>
                        
                        {/* 新店营建计划 */}
                        <div className="border border-gray-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">新店营建计划</h3>
                          <div className="text-gray-600">
                            <p>这里是新店营建计划的内容区域。</p>
                            <p className="mt-2">将展示新店营建的相关数据和计划。</p>
                          </div>
                        </div>
                        
                        {/* 门店变化统计 */}
                        <div className="border border-gray-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">门店变化统计</h3>
                          <div className="text-gray-600">
                            <p>这里是门店变化统计的内容区域。</p>
                            <p className="mt-2">将展示门店变化的相关统计数据。</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {activeTab === 1 && (
                    <div className="space-y-4">
                      <h2 className="text-xl font-bold text-gray-800">新店总结</h2>
                      <div className="text-gray-600">
                        <p>这里是新店总结的内容区域。</p>
                        <p className="mt-2">您可以在此展示新开店铺的运营情况和业绩表现。</p>
                      </div>
                    </div>
                  )}
                  
                  {activeTab === 2 && (
                    <div className="space-y-4">
                      <h2 className="text-xl font-bold text-gray-800">营业额总结-客单价</h2>
                      <div className="text-gray-600">
                        <p>这里是营业额总结（客单价）的内容区域。</p>
                        <p className="mt-2">您可以在此展示客单价相关的数据分析和趋势变化。</p>
                      </div>
                    </div>
                  )}
                  
                  {activeTab === 3 && (
                    <div className="space-y-4">
                      <h2 className="text-xl font-bold text-gray-800">营业额总结-客次量</h2>
                      <div className="text-gray-600">
                        <p>这里是营业额总结（客次量）的内容区域。</p>
                        <p className="mt-2">您可以在此展示客次量相关的数据分析和趋势变化。</p>
                      </div>
                    </div>
                  )}
                  
                  {activeTab === 4 && (
                    <div className="space-y-4">
                      <h2 className="text-xl font-bold text-gray-800">利润总结</h2>
                      <div className="text-gray-600">
                        <p>这里是利润总结的内容区域。</p>
                        <p className="mt-2">您可以在此展示利润相关的数据分析和财务表现。</p>
                      </div>
                    </div>
                  )}
                </div>
              </main>
            </div>
          );
        };

        const App = () => <WeeklyReport />;
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>