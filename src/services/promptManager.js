// src/services/promptManager.js
/**
 * 提示词管理服务
 * 管理不同数据文件的分析提示词
 */

class PromptManager {
  constructor() {
    // 初始化默认提示词模板
    this.prompts = new Map();
    this._initDefaultPrompts();
  }

  /**
   * 初始化默认提示词模板
   */
  _initDefaultPrompts() {
    // 月营销折扣率分析提示词
    this.prompts.set('4-客次量-月营销折扣率.csv', `
你是一个专业的数据分析专家，请分析以下月营销折扣率数据，并提供详细的分析结论：

数据格式：
月份,营销折扣率

请按照以下结构输出分析结果：
1. 整体趋势分析：分析营销折扣率的整体变化趋势
2. 异常点识别：指出明显偏高或偏低的数据点及其可能原因
3. 业务建议：基于数据分析提出可行的业务优化建议

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);

    // 床位利用率分析提示词
    this.prompts.set('4-客次量-床位利用率.csv', `
你是一个专业的酒店运营分析师，请分析以下床位利用率数据，并提供详细的分析结论：

数据格式：
时间,城市,床位利用率,达标标准,是否达标

请按照以下结构输出分析结果：
1. 整体达标情况：统计达标和不达标的城市数量及比例
2. 区域差异分析：分析不同城市的床位利用率差异
3. 时间趋势分析：分析床位利用率随时间的变化趋势
4. 改进建议：针对不达标的门店提出改进建议

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);

    // 会员运营结果统计分析提示词
    this.prompts.set('4-客次量-会员运营结果统计.csv', `
你是一个专业的会员运营分析师，请分析以下会员运营数据，并提供详细的分析结论：

数据格式：
日期,注册会员总数,当月有消费记录的会员-数量,当月有消费记录的会员-比例,当月新增会员数,当月新增会员占消费会员比例,当月活跃会员数,当月回流会员数,当月复购会员占消费会员比例,当月流失会员数量,流失会员占会员总数的比例

请按照以下结构输出分析结果：
1. 会员增长分析：分析会员总数的增长趋势
2. 活跃度分析：分析会员活跃度和复购率的变化
3. 流失分析：分析会员流失情况及其占比变化
4. 运营建议：基于数据分析提出会员运营优化建议

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);

    // 主动评价率统计分析提示词
    this.prompts.set('4-客次量-主动评价率.csv', `
你是一个专业的客户体验分析师，请分析以下主动评价率数据，并提供详细的分析结论：

数据格式：
时间,门店数,评价率达标店数,达标率,整体评价率

请按照以下结构输出分析结果：
1. 整体评价情况：分析整体评价率的变化趋势
2. 达标分析：分析达标门店数量和达标率的变化
3. 问题识别：识别评价率较低的时间段或潜在问题
4. 改进建议：提出提升客户主动评价率的具体措施

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);

    // 2025售后检视分析提示词
    this.prompts.set('4-客次量-2025 售后检视.csv', `
你是一个专业的售后服务分析师，请分析以下售后检视数据，并提供详细的分析结论：

数据格式：
月份,订单数量,投诉订单数量,投诉率,安抚金额,退款金额,赔付金额,总赔付金额,公司承担金额,公司承担比例,员工承担金额,员工承担比例

请按照以下结构输出分析结果：
1. 投诉趋势分析：分析投诉订单数量和投诉率的变化趋势
2. 赔付分析：分析各类赔付金额的变化及承担比例
3. 成本控制：评估售后成本对公司经营的影响
4. 优化建议：提出降低投诉率和控制售后成本的措施

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);

    // 年度利润统计分析提示词
    this.prompts.set('5-利润总结-年度利润统计.csv', `
你是一个专业的财务分析师，请分析以下年度利润统计数据，并提供详细的分析结论：

数据格式：
时间,一级类目,二级类目,金额,比例

请按照以下结构输出分析结果：
1. 收入分析：分析收入的变化趋势和构成
2. 成本分析：分析各项成本支出及其占比变化
3. 盈利能力：评估整体盈利能力和变化趋势
4. 财务建议：提出改善盈利能力的具体建议

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);

    // 通用分析提示词模板（用于未定义特定提示词的文件）
    this.prompts.set('default', `
你是一个专业的数据分析师，请分析以下数据，并提供详细的分析结论：

请按照以下结构输出分析结果：
1. 数据概览：简要描述数据的基本情况
2. 关键发现：指出数据中的重要趋势、异常或规律
3. 问题识别：识别潜在的问题或风险点
4. 改进建议：基于数据分析提出可行的优化建议

数据：
{{data}}

请用简洁明了的语言输出分析结果，不要使用任何格式化标记。
`);
  }

  /**
   * 获取指定文件的分析提示词
   * @param {string} fileName - 文件名
   * @returns {string} 提示词模板
   */
  getPrompt(fileName) {
    // 首先查找完全匹配的文件名
    if (this.prompts.has(fileName)) {
      return this.prompts.get(fileName);
    }
    
    // 查找部分匹配的文件名
    for (const [key, prompt] of this.prompts.entries()) {
      if (fileName.includes(key)) {
        return prompt;
      }
    }
    
    // 返回默认提示词
    return this.prompts.get('default');
  }

  /**
   * 添加或更新提示词模板
   * @param {string} fileName - 文件名
   * @param {string} promptTemplate - 提示词模板
   */
  setPrompt(fileName, promptTemplate) {
    this.prompts.set(fileName, promptTemplate);
  }

  /**
   * 删除提示词模板
   * @param {string} fileName - 文件名
   */
  removePrompt(fileName) {
    this.prompts.delete(fileName);
  }

  /**
   * 获取所有提示词模板
   * @returns {Map} 所有提示词模板
   */
  getAllPrompts() {
    return new Map(this.prompts);
  }

  /**
   * 清空所有提示词模板
   */
  clearAllPrompts() {
    this.prompts.clear();
    this._initDefaultPrompts();
  }
}

// 导出单例实例
const promptManager = new PromptManager();
export default promptManager;